<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Live Canvas — Open Image Link</title>
<style>
  :root{--bg:#071223;--muted:#9aa4b2}
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:system-ui,Arial}
  #canvas{width:100%;height:100vh;display:flex;align-items:center;justify-content:center;background:#000}
  #canvas img{width:100%;height:100%;object-fit:contain;display:block}
  .muted{color:var(--muted);font-size:13px;position:absolute;top:10px;left:12px}
  #status{position:absolute;top:10px;right:12px;color:var(--muted);font-size:12px}
</style>
</head>
<body>
  <div id="canvas">
    <div class="muted">Loading…</div>
  </div>
  <div id="status"></div>

<script>
/* ====== CONFIG via query params (defaults tuned for your sheet) ====== */
const Q = Object.fromEntries(new URLSearchParams(location.search));
const SPREADSHEET_ID = Q.sheet || '1B3mGxqHlMCzUYLXR0dc0ExvhVSFXTHSNq3C6Nt_t0Es';
const GID = Q.gid || '2094358974';
const RANGE = Q.range || 'A1';
const FALLBACK = Q.fallback || 'B1';
const POLL_MS = parseInt(Q.poll || '1500', 10);
/* ================================================================== */

const canvas = document.getElementById('canvas');
const statusEl = document.getElementById('status');

function gvizUrl(range){
  return `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?gid=${GID}&range=${encodeURIComponent(range)}&tqx=responseHandler:cb`;
}

async function fetchCell(range){
  try {
    const res = await fetch(gvizUrl(range), { cache:'no-store' });
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const txt = await res.text();
    const first = txt.indexOf('{'); const last = txt.lastIndexOf('}');
    if(first === -1 || last === -1) throw new Error('unexpected');
    const obj = JSON.parse(txt.slice(first, last+1));
    const rows = obj.table?.rows || [];
    if(rows.length === 0) return '';
    const c = rows[0].c && rows[0].c[0];
    const v = c ? (c.v ?? '') : '';
    return String(v);
  } catch(err){
    console.error(err);
    statusEl.textContent = 'fetch error';
    return null;
  }
}

function isImageUrl(s){
  if(!s) return false;
  s = s.trim();
  if(s.startsWith('data:image/')) return true;
  if(/^https?:\/\/.+\.(png|jpg|jpeg|gif|webp)(\?.*)?$/i.test(s)) return true;
  // drive direct link pattern
  if(/^https?:\/\/drive\.google\.com\/uc\?export=view&id=[A-Za-z0-9_-]+/.test(s)) return true;
  return false;
}

function showImage(url){
  canvas.innerHTML = '';
  const img = new Image();
  img.onload = ()=>{ canvas.appendChild(img); statusEl.textContent = 'loaded ' + new Date().toLocaleTimeString(); };
  img.onerror = ()=>{ canvas.innerHTML = '<div style="color:#eee;padding:12px">Unable to load image</div>'; statusEl.textContent = 'load error'; };
  img.src = url;
  img.style.objectFit = 'contain';
  img.style.width = '100%';
  img.style.height = '100%';
}

async function updateOnce(){
  statusEl.textContent = 'checking...';
  const v = await fetchCell(RANGE);
  if(v === null) { statusEl.textContent = 'error'; return; }
  if(isImageUrl(v)){
    showImage(v);
    return;
  }
  // fallback cell
  const f = await fetchCell(FALLBACK);
  if(f === null) { statusEl.textContent = 'error'; return; }
  if(isImageUrl(f)){
    showImage(f);
    return;
  }
  // not a URL — show raw text big
  canvas.innerHTML = '<div style="padding:20px;color:#fff;text-align:center;font-size:calc(18px + 2.5vw)">' + (v || f || 'No image URL found in cells') + '</div>';
  statusEl.textContent = 'no image url';
}

let loopTimer = null;
async function loop(){
  await updateOnce();
  loopTimer = setTimeout(loop, POLL_MS);
}
// start
loop();
</script>
</body>
</html>
